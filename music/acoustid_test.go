package music

import (
	"fmt"
	"os"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

// Creative Commons tracks, see test/source.md
var testTracks = []struct {
	path        string
	duration    string
	fingerprint string
	artist      string
	position    int
	title       string
	albumTitle  string
	mbReleaseID string
}{
	{
		"../test/Brad_Sucks_-_07_-_Total_Breakdown.mp3",
		"138",
		"AQADtFKWSFEURQxu9DmuRCtOkcOPRnqIijrmHQ985ciTFTxxSlEvVNnhfUWfHz-amBVuJai6Q-tg41kshD-O_sZ33EUTkTlyH72GJosiXDv042iOUNxx9Dnw6Igp6fAZVIf2o9GUxcKPH9oXNNfxDBneg_Q44QjVHs8gPuh1lMIpwaeOfuipw3XQJ2h-lHfwZOh1vEY_4avg-IL845cQHucVdFG1o0cj7fiD3IZHBjfOMoL2J0STHF8Ofcdlon3gZDtRSbaEP3hyXOgP8cRzNMWNm3BefNIhdTy-C9dRHs4XXIc9PbhAffhgOjGOqzncdyiLMzq-oPmEXseP88Fb9MRzw3qEcyPqH08OzTo88rgmHD9cSTqew_uL_kefKMcl9If-oy-aZx3-Bx3sF_6N8mgYoWR04cELTyLyFX8ThOuNJj_-4NvxE--JJikphDop_MET5HpwaC_xHBd6EbWJJscnXWBHGr-hXfCX4z1cnBGcD3qOZ0ce-MOo46UTNJp25DouBVr6CZEePHvw6sM_NJs89Ae_GN0H57vxhTlynKmMgzoH_eiJkEyPhn1x5FJ29NGhVTl-nIZ_cJ6J3-jDQyfKC022HCV3IdtxgzryHM-hJc6H8MJ7PHpRdviio9GDS37Qc8gT1IKOHt_Ri8TRo0lHEWS4Dzqq9WgcxByLfGhy9BmUE33gRoFr_AuewDKP_ngSQVcUo9kj9MifYNfxDnzQwU6PyjnyVMVz9PDIHP12PEcfNE-E58N39Bck7SnatFC-Kjg06mhc48vRqKGFn0K6HjdMaSlq_TgihbuEzicuZYeWV-CuIx_KhceXyMIv477h80YeaiS-Q_uD9D-8KMePJk2C-3jxhsgL_sOhUT3MZbiLI5WPN8cLPzty3BArxBf-Y8uFX3BV2KFwpFfwYxoDTT9umEXs4uJwWvgPH_fx5nCP6fjxPvhy5GJuXIJ25viJWjRiRjjCrDX6WNCVWRqOo2eQHj_xKQ9RktnQJzuaX_hRmeFhhbmEuD3Ea12RHy_MY08e_IfjHlWa48Lx-ni2Iz9-yM0xT0c7Dtbh400I_YIf4_iOa2jC49-hyYfPHG22Bw9RiwkaNcd5PAv6BeZx5viRbsV4Hs9x-OiDfvCzI8xt_BKuE-WD5jOJl0PVLB6aKhBvPJKF6xKsDI8q6Ef5oqGGO7OCPyjCUDqOPw--HM9xVA6PnNARqk_wF1MulOnxI7wOLVvzINeJoiFX4T9Rapk8NGL44Ee1CR9Oo0df5Me1QP1xOvh-eMvRHqehfUdzCz86PUaDHz-0OBdq7XiHfkej49zx9Zioo7kl7D962NsRomcOH-l4fNnxLRCTJiNaFf0OT2KM_oPGp3DF40pwxQhzrcJL9B_SLmj84NB5DWEvOJKKN8GP4g0d4UKbXcJ1_PgOD9PDIrSIxtAz1OPRnDiV0Hh-BZqmqPAX5INd5MfhPYHCKie6Iy9KouHxXLieIJUU3NByhE2PB9PDB4364PgihM_RqDyuHnp4Ycqk4iJxfIO_Cxd85njgSTmqaMwI1bpQOYQZ8ZAzLYe7Vegv1A48SniTC88LM_5wwv_wTIXf49C45EJ-Chce9Efz46lkoUdcnYLyHWUR_mh-PBn6Y0ru4j1SJ1HwGz_0O2gjhLGGH01-ocfeI_zhCrqDtMKD5zkcH-eDb7iawMWO0MZe6DxCfPBr_MC1JfhxPFqMWj9-rMV53DkuZbdwJUf1Hj7CyHShJ8SHO0c68jjj4Mo5HD2RPscJXULZHDnR_Ojxo_oNK58QP4b45Cx69IgU8vjyozkqKiQuPDN1HD--I8dxYk_CQNt8PEFeIoYfC_V2PAl6bHEWdBN-VKNy-LHwQx9OTbCO0ZlwuIWm6egUhDl2lDfs8Him4Pngt_CDWj_4J8Ir4TvS5SVOezgbg0l3aEfrkDhTVM41HA9jiJ_xHX8s5Bo6JkeT4Yf9BZeSKyhpNPmRN9HxFVouTCb-QeOT4ApyG88kDc6LskPuHBqnVXC34IPhK8JuHg9Eicpx5_jwB8cffD6OT4cZHx8vfIgeHq_xKBf64V-O_EEpET4aqthl6NJxHv1BOSkuxsmE9Dl6oXZeNNaKy0eOQuoS3LTwHccf_BD9BR96rEetQk_wHTnGRcGP3sdx5Cj3DD8oThuhc8cPy3ugv7BTMEXXt2jIWcQblISfozzyHb8RVzJ-Bz3x4-nhHz9yHjaOfIDtG9N3vC5OvrgZos-RnsX1G_mFB-bRE3tG6MR1NHbwvLjuUMj0mThc5-ij4kH-gIc-HTe5oNuh4zUO20efjfjE49CsLLAYIpfwE-aOSDye44R-_MF-ocdDiKdR9RJ6HfcI_vihZSQe3A-YnEWfRJZR62h0fNBzoZQP-8iPRj5iH-_RPIT-4ED64JmGH8d34caRHs4V_Ice_LDUGTlu4gt-wc8BQJAAQAqEmBKIAMAEAMpIAZgiRijCkABAGKQQUggKwwgAQAkDFSEEKGMYYwgYKggRQgAImBBKOEOIQqIIQRRxxhBhLBPAQGAsUARRoRhRCAhBgGNGACCBQYgCAQQxAACGDIJEIQIAUAoRyywxDAAADBCIIQQEEAAYoQwgAFRCiCHEAgIMI8ZYoAxxgxEElBDGCQEUM4AoY6QAhBBEgFCCACMMMgQAIgSjQBKhhFSCGEKEQ0IgACgQgFIkmICKMKAAgBIQhtRABFgFQMGGIASACMIYIoiAQhkBFGKIAwWUU0ApCQATiCgAiEBICLEEAQoQRwwBwAgAjCFGEAIBYopRQwQ5jCmAGABSAWGEocAMgAixAhDCEALKKREAU4IJwAhgCiyiGPEOEAAAEFQAAgBD1hFBmDEAYiUYUApgAAwDhCmKjAIAAAUEUAgIJgADzgAGCLMIAwgYUoAJhhgSDCECGBLUAEAUIxQpyhSDjCEjhDAAAEAAdQQQSAxxAiAjGBFKEiCoEYgQAwgwhAAkBFJGEGwMsUQQJYQRgCBgEEAMICWAUghJgwREAAgABCOGQgONYAQhhBgFAjmiEADIAEoSMQoAU4AQQgBgGCECKCA4IQIwQYASDCkikHJKIMMYMgICgwQwwgBiDAMEMGOQQcYQCKgg1FFkCPCMIQAEAwBgIgAiDBElkCFYUUGABYAwA4BmhhjiGRBoAYRIIABQgIRRDAmkmAKEKSGIAxIAZIhQEiEFBHIMICUMA0QJAIggxiDhGHLOGCoMMEQIBRAAFCBCCIAOOAQcgcwAQ4yAACMgkGAEAeIIIy4IKBpCgCFBjQCKEMCoiIoSYQAECggAhEHQAEIUY8IgARAxxgECDDFAQAQAUcIqYDgUDBAgsCNKEwIIgKAhQ4QiCwDjlGVGEciMYsgQIggGyAGEAEEeAQIIUEgRgJABACByEFIYCAOMJBQYIhAD",
		"Brad Sucks",
		7,
		"Total Breakdown",
		"Out of It",
		"064dbf15-3ef8-3fe2-8b56-3b9287c61e17",
	},
	{
		"../test/Nonima_-_07_-_Cfengine.mp3",
		"113",
		"AQADfQoXtSEuC_lR89B3HL1x8OiBCzp8I68KHoc7nMhxHjp-_DhEHNfwCwfcBT9-mAf-4giu4Tl-_EF5jMNrnPiRRzlOHdpzlMfxQx8ptB_8zPCFyjy-4BdudD98PNCJn8Pha6h-HO2YQ8uJ58P1oRkJ7cS14xp64_APfSEFmHiI78IPVzzeoDp-tC98Hv1x6Owx-fiFh_Cv4CYOx3gk5HAsHGdx5fiHX8KPHjm-g9AvIP6J4-iO__jB40cuPOKhE8ePHzfENceFHz_KHz_KE83xDt116Lhy4LUhHsdxXDrwG7Z4IS98_HiOUjd-7MGPI4e84zmO6zlwXjoOLYxzPBYc9EE-fBVa5Dh8Bs-hffiD5j164kc7BlpOPB9-NBEJ7cSPX8dzdNfhF18uCCb6oJ8FWH3Q58OPn0P9ws4L7fiOz0FY_MP24sdV4BlKHsfjI8fbCzpyEr_w4eiMHz6OHD7x4gR04cdzHH5xHIcO5Eb749QR3oPtoiU-4Tp6pD52MjglDz96_DheHN-F_PigPSk8C21OoNlT9Ie8nThu9EH65WjD4wjT7yj0o7qOdDryHT16HVrGHudxPfjRC1os6cQp4w_QPJiOsnAd40N4HD-q5_COPId_aHiC0Dgu4ToOv-KQH-Lxr8iBC8dfHKcFA0cO-QbCB7-O_EbNF00O_UcvvDgJ8TjyoY3Y4zh-7EV7nEQt5sKRH90M9ehx4UOzB_0F7Ufz4cHx4zt-AU1mod_xo7nRLpxw4xeaXB36HCd-DT96-EV34jnuoD78DHIXOH3w4uuR8uizENNxLfBZfJIJ_MKPX4JzhMcPHfnx4you4EdIHT_qEUeh45BvfMfh48gXHLiRwzy040fIE0ce-JCVEd-QH8eJFD9-nLCPD0ceGT_OA_2QXwZe_NCnEz18HOrhHT1y5cUlHJ2y4bdwpMeBHz98fMOQ_njgD0eO6xB_HA-PDw_EZ-jQ83CpHD1-ohcaXviOwk8gG9WPCz_Rwvmh4XtxFDl3WD_q5jgeWMeP7wsq-DlCfR5-6PiPioev4Phx5PAj9LjQL2hK4Uevo3lwYz-eC_nRQ_xM_Mi7wD9yxB5-XIGJI4N_HJ8gHscP49pw9zBzPDgE4MWN49DBw4dOdfiNFO_RF29xXD-OH_kxvUZ5LviO48d16MGvQ0cbMWieCP0lNDE-_Ch0Cu1xHu2D5sOdD10OLXvwZcaP8oevog9OEj_0H30hVkTn4zt-9LOQPjtObL1xCp_hB90UIv9xCu2ha_B_4EObDecjvIZ2hFElPCqO44_QG34QHf0JaD_-wB2P7xX-HSeuQ-R09AymB7ZQbcdLoT889MODUsNxQj54PMFF_IffCs9DhM6GG6fhvfhxKofF5Hgo5FJ06C_ChEdIBg_ChNXRZ2D4I0ueKJJwyAr6I83xhscZ5Md_6FGQGv1xHd_QPKh6_Ki-Ij2jHP3xG9IZtIyIXMIroVaIE_2Aa-jxJQdyUUdSa8RbdGfhsImKL0TLtCgffIcv49qRMxMkfaiQu0bGPMf_FO0Kgcd_ZDp-otcRPrD14CK-Hh-o_6g-TA-OB8_xw-uOcM-BD314NJO64SdyEj-0G3ePi0e55Kh96AncCZGPT0G7_EJ52OLR60iOLJykw8yO64eTz3hHzTAPXkHaTEZyBj1-4hmLJuS4o04y6kD4oBnDgudx5micBVaDVsFzaLC1WOhztLAmBjo_OD_C0wF91MdmbUS1mEIOLfrRF3l0DeeNH80zdI6O_Gh_KDseHsjbBv0QHs1x4eKh5_iLPg-ewSpu3FFKaB6PT_i6o-WFHseVo1cGk3pwSYV-4_7QbTTeDvpyNGR0lH2RH312fI8E6kTZ4Rea_EF7xJyGLmsF8SF6GqGE7_iSB29GZDo8Eppe4kuQA0IEUYIyRwwhUBkCwQPUCWPFmEYKABxzShCsJFJWMUsNBAgwJQR5VggAhGPCEKAYEoQZA5wADABHhOVIBCsYEwgQ4SgQgBAAEgHGKSEAYuYxZBgkAkjBKIEMICsgEsoBBwkUQnFHELTECWCFMMYJRQBwQhiBhAqAIGChg8oygLBFVDvFKBDCAECBU4yBCpiSgAChnAEMEEcMYEJI4gAwQggiCDAGAGESYpAARxEzahkJmJWWCAKGFqVapIRxBG0ErdMEACTAJloBABWTgFNEiFICGaEAEAQJQTgQyggCGEBCCEMIQ8oARCBSDkMJgHTCAUNRB8IgBQQQTHJh0CMfccEEEUIBIoDG5AnCAmUQMKSURYo7QYhEgkKijKGAAMEQIIwIQQQzzgLCiAFAMUeAwEgYhCgiRgyqlCYUWvQI4wZKaYSyBjwRjSAIGcK5hUoEJK3QTBpkBEASAKSQMEqRQSwTABQiFXKGEIKIoQJJqQSihiAKBBBaUOQQMkaIZBAQxhFghODiQIQAAgAKLISAhCyFqMCOOAAMokopAYkiCBGAKAOiCyattoZJAYBD3CJA0VZGEOgYIEigi5QRQiimGBDQASKAEA4g6BgBAAAnDBMCGEEEFAAwwIABBgAGiDNCEOoIEcQSoxiDihmFvBHEEACEAAJQZYxAQhgCrHkGGAeIMIZRQyABBJEBBABKCYEACcQC4AAACCCDEEIICAaAAcgwIiglihMgACNEOEIVUNIJAAjgRghDhRFKIQMcIcAggQxzyBGBgHCACE6AQIBBCBUAxhkIhQBEAQIBAtEwQAgwRDEDnDACEQwoEcQARCRBzDAglECKcOIIQMQQJRgBABIgrFXUCgQIUAwQghASQADAhBEQCGOIoQowCw",
		"Nonima",
		7,
		"Cfengine",
		"Karmadebt",
		"91671165-a882-4d21-a9a6-b48129caf6d6",
	},
		{
		"../test/07 Cfengine.flac",
		"113",
		"AQADfAq3NsQv5IfmRcdx9MbBCwUOHX6Q9-DhaTgRPNAZ4Md9-NAPXMMvHIcfHB9MHH-B4Nbw48cflMc4PDWOXDm-DxXFQ0f5A_-hE80Z_PCFyjy-4BfuoDt86BmOn8MHf6h-_NDCMegznB_-oRkZaMe1H__QC_Bz6CsFmHiIzxJ-Eq6IN6g-_OgLn0d__IdeTD5-4WHhPzjh4nikI3AsHGdx5cR__MKPHvl2EMIvHPFP4Oh2_PjBD_mP4-OhE8eP3wLENceFH_-DHt9RkkTz4A20PQeuHIfew8dxHJeO44ctXsgLHz-eo9SNH3vwI8cJeXiOP8eP47yE9oFYW3iMJseRD98qFDke-Bn6Qx-qB35X9MeJ5gy0Z8R59GgiEjrxkfiK7il--KXwBTqMPuhnAVbzoDI94DGHvhCdF_XxXLiN8PiM7cFxFcc79MeP-4iP94KOnCT-4zg6H4cvBB98vDghXMLxfIBfHMehI-gb_Dh1IbxhykV_vLiOHtEotfhwSkd_HD-OF8d3CbkgH70KT9TRHj28B90PfSd-lPCD8Mvx8Oh5pHWGHupRWkfaI7xy_GjOQyOZ4sT14EdzndAuCaeMP8CUBz3KDu6NfOjx40L1w8uRH_6hHXlQHz_OCz_MIz8H8cfxr8hxHMdf4oJPADkO-TOO8FpwHbmDJiSpodB_9DIu_BB_5Ch5PO6B48f-FMWZoZR44UN-dDPUo8eFD826oBe0_OiHBzeO78OPXnA29BmHH83RLpxwH-UJ587Q4y9-_OjRnMF9_LiD-vAzyF3g1A7Owj_yh-izY4KrxTjxSSbwCz9-6XCMEPrxI8ePq8Jx1EP-40d9_OihC9BvHL6AH3kKIDcO89B-1Cdy5PCDH7IyGkd-HCdS_Phxwj4-HHm04cGPHjfyG8eh67hO9PDxHqKHH-GN68Ul_Ea34bdwpMfx4zj84EYEX4ePD0cOXy_0Ae9x-JAb9Oh1wXUQHn9OhHmM9viOHr4ge0eFT_hR7WieQ8b3AkXOXbCuozaOPmj04Tj3Bf3hF6EeHYeO_6jowx-OH0dO-Dp6oEfTBUdj7eiDY9-RX8Kh5fgo4kjZBXkNxMePCyaODP7xCj50vDDx41Fxw8zx4BAOfA2O49DBwz90d_iN9PjRu_iLHxd-_Eb0oWeMLl_w43h7_NDx69AjNDz6BE18CT1x_NCOj2h5nEfDB5WjDie05Ubz4sso_CgPv-jxnMIP3egLLTVuFd_xoPmFfMcO98Yp4TOsC7Uy5B9OtOkhXvhxnCPq47zwGlqOcE2Er_jw40Jv-Dmioz909PCe42PwXfh3nLgOkZOOvpgeOBXaHS-FkD5S9Bu-ojxwQt7B4xl-4vrhlxHaxC5yCudRfmie4kcTKkfH5EE-vcJJQz-RhsgZvEHa6uDRjDWR5YkmXDl0NCny481xBvnx89CzGOmHmvhRb7AbVBce9AsR5lyO6-Bt6FnQTkauCxeLfsGPHkc__Phy5IcuMUT8oaeHP3DY5CgXaTiP8vCPy7iWBjkJSR8YHbmPPE-Fzy_6QjhuHelxoleO8IP94CI-5qB-9CV-TI_xHcdz_EjXHd1zHBd6kmgm1fiJnETnQ6_w4-JRLjlqH-KZ4FJ0RL_QKtrxH-UDWwgPncjCkoSzjHh8w_mOdx7Mg0-ChJVkhA-OxyTOBw4TjfhGAeks8FIqHOW0w7pgLkQP_egPW_vwwDxkRTX-IM3BnA5xTD5sbUS1mEJ-aPlRH_k1nDeeo3mGzjnyY-oPUcd5BH3bIB-ao8eFi4ee41fRP3gGq7io48qhecet4TKH9uiNB1fOoR_MTA90SqFw4-MHbb2gv9CVE82jo-yR6-ip4vsEaiT6GZVPNPwR-7gURWjElIJ2nDRCDT--5Aqoe0QOj4QmZyJyASKIAKQyRwh5ChgolhNGWSekkQIJIBZBTFGkrGKUA0cQkUI4QhBwBAjHhJEKMUGYMsApQQSQRAgjAQVUMIaAcAYwQAhgRkBgnBKGMUYcQ4YJQwSQghHKHAJCYeUAEkBYIRR3BAHiBCBEKIMQEUAILpRAQgVgCgIWOqgsAwhbJLliRAhg5AHAGcsMqEAwTIACBgiCrDJgiACMEEIYJjQjxkMAEyPCKMmMUcxKBIggBF7QLXLCEY2gddIQQARRYBNtATHKSsApIsQQJJAVBBAggCHCECUIJYAAKAAxhCFFBEAEIgUYhsIJyQQERlHJBDHAKAkAcEAwK7kwYogwpBScAiIAyEJQZA0AlAHAFFEWKe4sRIQSbgwFSAiIACKEECWgcRYIwIwBgAlKgADOIEQRMQIqB1iFloUBgQMAKu8IAAcK6pAgQgghLeFQiYCkFZpJgwyAGAIikUDMKAUYIcoRYAAhUiFnLBGICOWQNEAZ4pQwQAshkERIGcGRAwggQIAAHAMTgBIKEJCFEISQpRAjADEOFChKCYkgUkQD0QWTSlwprAAOoSsSoGgJZYQgWgDkBbHEMCAUUgwIQqADRAghhAPIOsMIIAIYCoAiQhgHhTCGEsKAA8QJ4agAoFijCFKKKWbEQkAcoTAQSDAgAFVGCCQEAYg6IAwBAAhjDBEIEoIMIUIIoIwQDksBkAMAAGAoQwoQYAxiSDBEHFCKOEWEI0AIoYBBRCiwlMQOAQGEIEcgcgBxyABBDTBIKGWYQ44IpIQDBCKAEWAQEOOAcgAQYwRBiECg1GMCEUQEUIYJoIBTghgADBICEUSkQNAwIAxBgmnjCEDEACYYAI4gopSiylgBAAIIEEGEkIgIAYgARBFCmCECUQg",
		"Nonima",
		7,
		"Cfengine",
		"Karmadebt",
		"91671165-a882-4d21-a9a6-b48129caf6d6",
	},
}

func TestAcoustid(t *testing.T) {
	fmt.Println("+ Testing Acoustid...")
	check := assert.New(t)

	// get api key from env
	key := os.Getenv("ACOUSTID_API_KEY")
	require.NotEqual(t, 0, len(key), "Cannot get Acoustid API key")

	for _, t := range testTracks {
		fmt.Println("Testing with " + t.path)
		a := NewAcoustid(key)
		err := a.CalculateFingerprint(t.path)
		check.Nil(err)
		check.Equal(t.duration, a.Duration, "Unexpected track duration")
		check.Equal(t.fingerprint, a.Fingerprint, "Unexpected track fingerprint")

		results, err := a.LookUp()
		check.Nil(err)

		check.Equal("ok", results.Status)
		// TODO case where no results
		if len(results.Results) != 0 {
			check.Equal(t.artist, results.Results[0].Recordings[0].Artists[0].Name)
			check.Equal(t.title, results.Results[0].Recordings[0].Title)
			check.Equal(t.albumTitle, results.Results[0].Recordings[0].Releases[0].Title)
			check.Equal(t.position, results.Results[0].Recordings[0].Releases[0].Mediums[0].Tracks[0].Position)
			check.Equal(t.title, results.Results[0].Recordings[0].Releases[0].Mediums[0].Tracks[0].Title)
			check.Equal(t.mbReleaseID, results.Results[0].Recordings[0].Releases[0].ID)
		}

	}

}
